<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>DOM ResizeObserver API | 前端学习与摸鱼艺术</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/fav.png">
    <meta name="description" content="blog；frontend developer；">
    
    <link rel="preload" href="/assets/css/0.styles.f47b8e7c.css" as="style"><link rel="preload" href="/assets/js/app.071cd255.js" as="script"><link rel="preload" href="/assets/js/2.4273f165.js" as="script"><link rel="preload" href="/assets/js/8.03582686.js" as="script"><link rel="prefetch" href="/assets/js/10.8e8c3587.js"><link rel="prefetch" href="/assets/js/11.62eda90a.js"><link rel="prefetch" href="/assets/js/12.664b49b9.js"><link rel="prefetch" href="/assets/js/13.69662d95.js"><link rel="prefetch" href="/assets/js/14.4446e6c3.js"><link rel="prefetch" href="/assets/js/15.92ec6d48.js"><link rel="prefetch" href="/assets/js/16.be52545c.js"><link rel="prefetch" href="/assets/js/17.dde73455.js"><link rel="prefetch" href="/assets/js/18.6dad4d17.js"><link rel="prefetch" href="/assets/js/19.655e0e4d.js"><link rel="prefetch" href="/assets/js/20.ed08ebea.js"><link rel="prefetch" href="/assets/js/21.66a57168.js"><link rel="prefetch" href="/assets/js/22.36bcce31.js"><link rel="prefetch" href="/assets/js/3.22a93f47.js"><link rel="prefetch" href="/assets/js/4.f5b78cf2.js"><link rel="prefetch" href="/assets/js/5.880d05f7.js"><link rel="prefetch" href="/assets/js/6.15993fb5.js"><link rel="prefetch" href="/assets/js/7.b0a25221.js"><link rel="prefetch" href="/assets/js/9.25b92fb7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f47b8e7c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">前端学习与摸鱼艺术</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
    首页
  </a></div><div class="nav-item"><a href="https://github.com/MatRunner/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.yuque.com/mouzaixiulianneigongdeyangtongxue" target="_blank" rel="noopener noreferrer" class="nav-link external">
    语雀
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
    首页
  </a></div><div class="nav-item"><a href="https://github.com/MatRunner/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.yuque.com/mouzaixiulianneigongdeyangtongxue" target="_blank" rel="noopener noreferrer" class="nav-link external">
    语雀
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/" class="sidebar-heading clickable router-link-active"><span>介绍</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/" aria-current="page" class="sidebar-link">关于本博客</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/tech/introduction" class="sidebar-heading clickable open"><span>踩坑合集</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/tech/npm.html" class="sidebar-link">如何发布一个npm包</a></li><li><a href="/tech/webpack_export.html" class="sidebar-link">使用webpack打出一个有导出的包</a></li><li><a href="/tech/about_const.html" class="sidebar-link">竟然被const坑了一把</a></li><li><a href="/tech/sso.html" class="sidebar-link">集成sso的前端项目在开发阶段绕过登陆</a></li><li><a href="/tech/md_parser.html" class="sidebar-link">面向业务的Markdown解析脚本</a></li><li><a href="/tech/resizeObserver.html" aria-current="page" class="active sidebar-link">浅用ResizeObserver API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tech/resizeObserver.html#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/tech/resizeObserver.html#思路" class="sidebar-link">思路</a></li><li class="sidebar-sub-header"><a href="/tech/resizeObserver.html#实施" class="sidebar-link">实施</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/fish/introduction" class="sidebar-heading clickable"><span>摸鱼杂谈</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/fish/材料那几年.html" class="sidebar-link">材料那几年</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/design-pattern/introduction" class="sidebar-heading clickable"><span>设计模式思考与实践</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/design-pattern/singleton.html" class="sidebar-link">单例模式</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="dom-resizeobserver-api"><a href="#dom-resizeobserver-api" class="header-anchor">#</a> DOM ResizeObserver API</h1> <h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <p>又是一个周六，由于组内一小姐姐离职，我要去接受她的项目，加上产品直接定了版本发布日。我又“自愿”加班去了。</p> <p>加班不可避免，只能思考如何让加班变得有效。</p> <p>场景需求：实现页面右下的固钉，距离viewport底部固定距离；紧贴内容部分右侧，页面宽度小于内容宽度时，固钉紧贴viewport右侧。</p> <p><img src="/assets/img/floatNav.70794cc5.gif" alt="floatNav"></p> <h2 id="思路"><a href="#思路" class="header-anchor">#</a> 思路</h2> <p>能用CSS解决的先用CSS解决。分析需求可知：</p> <ol><li>距离视窗底部固定距离，显然是<code>position: fixed;</code>;</li> <li>横向的行为类似于<code>position: sticky</code>，但是仔细一想，是和需求1冲突的。</li></ol> <p>也许这种效果确实能用CSS实现，但已经不是我一时半会能想出来的了。因此直接js介入。</p> <p>方案：纵向位置使用css的fixed定位实现，横向位置使用js来控制。</p> <h2 id="实施"><a href="#实施" class="header-anchor">#</a> 实施</h2> <p>固钉的位置与页面距离视窗右侧的距离有关，细分下，需要实现对window宽度变化的监听，并实时计算页面主体距离右侧视窗的距离。</p> <h3 id="事件监听"><a href="#事件监听" class="header-anchor">#</a> 事件监听</h3> <p>监听window的宽度变化可以使用(前端程序员)都知道的<code>addEventListener('resize',callbakc)</code>方法，需要注意的是：</p> <ol><li>resize事件只能监听window；</li> <li>该事件会高频触发，基本都需要做节流。</li></ol> <p>顺手来上一段MDN的节流方案：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// requestAnimationFrame + customEvent</span>
<span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> <span class="token function-variable function">throttle</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> name<span class="token punctuation">,</span> obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        obj <span class="token operator">=</span> obj <span class="token operator">||</span> window<span class="token punctuation">;</span>
        <span class="token keyword">var</span> running <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> <span class="token function-variable function">func</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>running<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
            running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
             <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                obj<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomEvent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                running <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        obj<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">/* init - you can init any event */</span>
    <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token string">&quot;resize&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;optimizedResize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// handle event</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;optimizedResize&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Resource conscious resize callback!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="resizeobserver"><a href="#resizeobserver" class="header-anchor">#</a> ResizeObserver</h3> <p>事件监听通常和节流绑定，显得上面的实现内聚性少了那么点意味。DOM还有一个*Observer系列的api，ResizeObserver就是其中一个。</p> <blockquote><p>ResizeObserver 接口可以监听到 Element 的内容区域或 SVGElement的边界框改变。内容区域则需要减去内边距 padding。
ResizeObserver 避免了在自身回调中调整大小，从而触发的无限回调和循环依赖。它仅通过在后续帧中处理 DOM 中更深层次的元素来实现这一点。如果（浏览器）遵循规范，只会在绘制前或布局后触发调用。</p></blockquote> <p>MDN并没有解释很清楚，我又找了其他说明 👉 :<a href="https://web.dev/i18n/en/resize-observer/#when-is-it-being-reported" target="_blank" rel="noopener noreferrer">ResizeObserver: it’s like document.onresize for elements<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>When is it being reported?
The spec proscribes that ResizeObserver should process all resize events before paint and after layout. This makes the callback of a ResizeObserver the ideal place to make changes to your page's layout. Because ResizeObserver processing happens between layout and paint, doing so will only invalidate layout, not paint.</p></blockquote> <p>看样子并不需要进行额外的节流处理。由于是在react中使用，顺手写一个hook：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">useResizeObserver</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> resizeObserver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResizeObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entries</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entry <span class="token keyword">of</span> entries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    resizeObserver<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      resizeObserver<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>之后将监听document.body的回调作为callback传入即可。</p> <h3 id="右边距计算"><a href="#右边距计算" class="header-anchor">#</a> 右边距计算</h3> <p>实现了对window的监听后，需要得到页面主体到视窗右侧的距离，这里使用<code>element.getBoundingClientRect()</code>，但是这个api所有的属性都是相对于视窗左上的，还需要使用<code>window.innerWidth</code>减一下才能得到距离右边的距离。</p> <p>至此，功能就完成了。但是总感觉功能实现的不是很漂亮。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新于:</span> <span class="time">8/28/2022, 1:51:06 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/tech/md_parser.html" class="prev">
          面向业务的Markdown解析脚本
        </a></span> <span class="next"><a href="/fish/材料那几年.html">
          材料那几年
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.071cd255.js" defer></script><script src="/assets/js/2.4273f165.js" defer></script><script src="/assets/js/8.03582686.js" defer></script>
  </body>
</html>
